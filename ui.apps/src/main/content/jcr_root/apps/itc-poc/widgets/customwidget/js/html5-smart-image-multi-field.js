CQ.Ext.ns("ExperienceAEM.ImageMultiField");ExperienceAEM.ImageMultiField.Panel=CQ.Ext.extend(CQ.Ext.Panel,{initComponent:function(){ExperienceAEM.ImageMultiField.Panel.superclass.initComponent.call(this);var b=this.findParentByType("imagemultifield"),c,e=["cropParameter","fileNameParameter","fileReferenceParameter","mapParameter","rotateParameter"];var a=this.find("xtype","imagemultifieldsmartimage");b.nextPanelNum=b.nextPanelNum+1;var d=this.name=this.name+"/"+b.nextPanelNum;CQ.Ext.each(this.items.items,function(f){if("imagemultifieldsmartimage"==f.xtype){return}c=f.name?f.name:f.id;f.name=d+"/"+(c.indexOf("./")===0?c.substr(2):c)});CQ.Ext.each(a,function(g){var f=g.name;if(f.indexOf("./")===0){f=f.substr(2)}f=d+"/"+f;g.name=f;CQ.Ext.each(e,function(h){if(g[h]){g[h]=f+"/"+(g[h].indexOf("./")===0?g[h].substr(2):g[h])}});CQ.Ext.each(g.imageToolDefs,function(h){h.transferFieldName=f+h.transferFieldName.substr(1);h.transferField.name=h.transferFieldName});this.add(new CQ.Ext.form.Hidden({name:g.name+"/sling:resourceType",value:g.imageSlingResourceType}))},this)},setValue:function(c){var j=this.findParentByType("imagemultifield"),i,h,b,d,e,a;var g=this.find("xtype","imagemultifieldsmartimage");var f=c.get(this.name);if(f){CQ.Ext.each(this.items.items,function(k){if("imagemultifieldsmartimage"==k.xtype){return}i=f[k.name.substr(k.name.lastIndexOf("/")+1)];if(i){k.setValue(i)}})}CQ.Ext.each(g,function(k){d=j.path+"/"+k.name;e=CQ.Util.copyObject(c);a=e.get(k.name);for(h in a){if(a.hasOwnProperty(h)){e.data[h]=a[h]}}e.data[j.name.substr(2)]=undefined;b=k.fileReferenceParameter;k.fileReferenceParameter=b.substr(b.lastIndexOf("/")+1);k.processRecord(e,d);k.fileReferenceParameter=b},this)},validate:function(){return true},getName:function(){return this.name}});CQ.Ext.reg("imagemultifieldpanel",ExperienceAEM.ImageMultiField.Panel);ExperienceAEM.ImageMultiField.SmartImage=CQ.Ext.extend(CQ.html5.form.SmartImage,{syncFormElements:function(){if(!this.fileNameField.getEl().dom){return}ExperienceAEM.ImageMultiField.SmartImage.superclass.syncFormElements.call(this);if(this.moveParameter){this.moveParameter.getEl().dom.name=this.name+CQ.Sling.MOVE_SUFFIX}},afterRender:function(){ExperienceAEM.ImageMultiField.SmartImage.superclass.afterRender.call(this);var c=this.findParentByType("dialog"),d=this.dropTargets[0],b,a;if(c&&c.el&&d.highlight){a=parseInt(c.el.getStyle("z-index"),10);if(!isNaN(a)){d.highlight.zIndex=a+1}}d.parentMultiFieldItem=this.findParentByType("multifielditem");b=this.findParentByType("multifield");b.dropTargets.push(d);this.dropTargets=undefined},onFileSelected:function(a,c){var b=this.name;this.name="./"+this.name.substring(this.name.lastIndexOf("/")+1);ExperienceAEM.ImageMultiField.SmartImage.superclass.onFileSelected.call(this,a,c);this.name=b}});CQ.Ext.reg("imagemultifieldsmartimage",ExperienceAEM.ImageMultiField.SmartImage);CQ.Ext.override(CQ.form.SmartImage.ImagePanel,{addCanvasClass:function(b){var a=CQ.Ext.get(this.imageCanvas);if(a){a.addClass(b)}},removeCanvasClass:function(b){var a=CQ.Ext.get(this.imageCanvas);if(a){a.removeClass(b)}}});CQ.Ext.override(CQ.form.SmartImage.Tool,{processRecord:function(a){var b=a.get(this.transferFieldName);if(!b&&(this.transferFieldName.indexOf("/")!==-1)){b=a.get(this.transferFieldName.substr(this.transferFieldName.lastIndexOf("/")+1))}if(b===null){b=""}this.initialValue=b}});CQ.Ext.override(CQ.form.MultiField.Item,{reorder:function(d){if(d.field&&d.field.xtype==="imagemultifieldpanel"){var e=this.ownerCt,b=e.items.indexOf(d),a=e.items.indexOf(this);if(b<a){e.insert(e.items.indexOf(d),this);this.getEl().insertBefore(d.getEl())}else{e.insert(e.items.indexOf(this),d);this.getEl().insertAfter(d.getEl())}e.doLayout()}else{d.field.setValue(this.field.getValue());this.field.setValue(d.field.getValue())}}});ExperienceAEM.ImageMultiField.MultiField=CQ.Ext.extend(CQ.form.MultiField,{Record:CQ.data.SlingRecord.create([]),nextPanelNum:0,initComponent:function(){ExperienceAEM.ImageMultiField.MultiField.superclass.initComponent.call(this);var b=this.findParentByType("dialog");b.on("beforesubmit",function(){var d=this.find("xtype","imagemultifieldpanel"),c=[];CQ.Ext.each(d,function(e){c.push(e.name.substr(e.name.lastIndexOf("/")+1))});$("<input />").attr("type","hidden").attr("name",this.getName()+"/order").attr("value",JSON.stringify(c)).appendTo($(b.form.el.dom))},this);this.dropTargets=[];this.on("removeditem",function(c){a.call(this,c)});var a=function(c){var d=[];var f=c.findByType("multifielditem");if(_.isEmpty(f)){return}var e=_.pluck(f,"id");CQ.Ext.each(this.dropTargets,function(g){if(_.contains(e,g.parentMultiFieldItem.id)){d.push(g)}},this);this.dropTargets=d}},addItem:function(a){if(!a){a=new this.Record({},{})}ExperienceAEM.ImageMultiField.MultiField.superclass.addItem.call(this,a)},processRecord:function(a,e){if(this.fireEvent("beforeloadcontent",this,a,e)!==false){this.items.each(function(g){if(g.field&&g.field.xtype==="imagemultifieldpanel"){this.remove(g,true)}},this);var c=a.get(this.getName()),d,b,f;this.nextPanelNum=0;if(c){d=this.getName()+"/order";b=a.get(d)?a.get(d):"";f=JSON.parse(b);CQ.Ext.each(f,function(g){this.nextPanelNum=parseInt(g,10)-1;this.addItem(a)},this)}this.fireEvent("loadcontent",this,a,e)}}});CQ.Ext.reg("imagemultifield",ExperienceAEM.ImageMultiField.MultiField);